# Configuração do Apache Virtual Host para Controle de Estoque
# Arquivo: /etc/apache2/sites-available/controle-estoque.conf

<VirtualHost *:80>
    ServerName seu-dominio.com.br
    ServerAlias www.seu-dominio.com.br
    
    # Diretório raiz da aplicação
    DocumentRoot /var/www/controle_estoque_db
    
    # Configuração WSGI
    WSGIDaemonProcess controle_estoque python-path=/var/www/controle_estoque_db python-home=/var/www/controle_estoque_db/venv
    WSGIProcessGroup controle_estoque
    WSGIScriptAlias / /var/www/controle_estoque_db/wsgi.py
    WSGIApplicationGroup %{GLOBAL}
    
    # Configuração de diretórios
    <Directory /var/www/controle_estoque_db>
        WSGIApplicationGroup %{GLOBAL}
        Require all granted
    </Directory>
    
    # Servir arquivos estáticos diretamente pelo Apache
    Alias /static /var/www/controle_estoque_db/static
    <Directory /var/www/controle_estoque_db/static>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
    </Directory>
    
    # Alias para downloads de relatórios
    Alias /relatorios /var/www/controle_estoque_db/relatorios
    <Directory /var/www/controle_estoque_db/relatorios>
        Require all granted
        Options -Indexes
    </Directory>
    
    # Logs do Apache
    ErrorLog ${APACHE_LOG_DIR}/controle_estoque_error.log
    CustomLog ${APACHE_LOG_DIR}/controle_estoque_access.log combined
    LogLevel info
    
    # Configurações de segurança
    ServerTokens Prod
    ServerSignature Off
    
    # Headers de segurança
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'"
    
    # Compressão gzip
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # Cache para arquivos estáticos
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
        Header append Cache-Control "public"
    </LocationMatch>
    
</VirtualHost>

# Configuração HTTPS (SSL) - Opcional mas recomendado
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName seu-dominio.com.br
    ServerAlias www.seu-dominio.com.br
    
    DocumentRoot /var/www/controle_estoque_db
    
    # Certificados SSL (Let's Encrypt ou outro)
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # SSLCertificateChainFile /path/to/your/ca_bundle.crt
    
    # Configuração WSGI (mesma do HTTP)
    WSGIDaemonProcess controle_estoque_ssl python-path=/var/www/controle_estoque_db python-home=/var/www/controle_estoque_db/venv
    WSGIProcessGroup controle_estoque_ssl
    WSGIScriptAlias / /var/www/controle_estoque_db/wsgi.py
    
    <Directory /var/www/controle_estoque_db>
        WSGIApplicationGroup %{GLOBAL}
        Require all granted
    </Directory>
    
    # Aliases (mesmos do HTTP)
    Alias /static /var/www/controle_estoque_db/static
    <Directory /var/www/controle_estoque_db/static>
        Require all granted
    </Directory>
    
    Alias /relatorios /var/www/controle_estoque_db/relatorios
    <Directory /var/www/controle_estoque_db/relatorios>
        Require all granted
        Options -Indexes
    </Directory>
    
    # Logs SSL
    ErrorLog ${APACHE_LOG_DIR}/controle_estoque_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/controle_estoque_ssl_access.log combined
    
</VirtualHost>
</IfModule>