<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão Completa de Bens - CEAD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
    <!-- Header -->
    <header class="bg-primary text-white shadow-sm">
        <div class="container py-3">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-1 fw-bold">
                        <i class="bi bi-gear me-2"></i>Gestão Completa de Bens
                    </h1>
                    <p class="mb-0 opacity-75">Sistema de CRUD - Criar, Ler, Atualizar e Excluir</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Voltar ao Início
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container py-4">
        <!-- Alertas -->
        {% if mensagem %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ mensagem }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Card de Estatísticas -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-database text-primary fs-1"></i>
                        <h4 class="mt-2 fw-bold">{{ total_count|number_format }}</h4>
                        <p class="text-muted mb-0">Total de Bens</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-check-circle text-success fs-1"></i>
                        <h4 class="mt-2 fw-bold">{{ localizados_count|number_format }}</h4>
                        <p class="text-muted mb-0">Localizados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-clock text-warning fs-1"></i>
                        <h4 class="mt-2 fw-bold">{{ nao_localizados_count|number_format }}</h4>
                        <p class="text-muted mb-0">Pendentes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-3">
                        <i class="bi bi-plus-circle text-info fs-1"></i>
                        <h4 class="mt-2 fw-bold">Novo</h4>
                        <p class="text-muted mb-0">Adicionar Bem</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra de Ferramentas -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <form method="GET" action="{{ url_for('sistema_crud') }}" class="row g-2">
                            <div class="col-auto">
                                <div class="input-group">
                                    <input type="text" name="q" class="form-control" 
                                           placeholder="Buscar por nome ou número..." 
                                           value="{{ termo_busca }}">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i>
                                    </button>
                                    {% if termo_busca %}
                                    <a href="{{ url_for('sistema_crud') }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <button class="btn btn-success" onclick="abrirModalCriacao()">
                            <i class="bi bi-plus-circle me-1"></i>Novo Bem
                        </button>
                        <div class="btn-group ms-2">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" 
                                    data-bs-toggle="dropdown">
                                <i class="bi bi-download me-1"></i>Exportar
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('exportar', tipo='localizados') }}">
                                    <i class="bi bi-check-circle text-success me-2"></i>Localizados
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('exportar', tipo='nao-localizados') }}">
                                    <i class="bi bi-clock text-warning me-2"></i>Não Localizados
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#">
                                    <i class="bi bi-database text-primary me-2"></i>Todos os Bens
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Bens -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Lista de Bens Patrimoniais
                    <span class="badge bg-primary ms-2">{{ paginacao.total_registros }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                {% if paginacao.dados %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Número</th>
                                <th>Nome</th>
                                <th>Situação</th>
                                <th>Localização</th>
                                <th>Responsável</th>
                                <th>Última Atualização</th>
                                <th width="120">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bem in paginacao.dados %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ bem.numero }}</strong>
                                </td>
                                <td>{{ bem.nome }}</td>
                                <td>
                                    {% if bem.situacao == 'OK' %}
                                    <span class="badge bg-success">Localizado</span>
                                    {% else %}
                                    <span class="badge bg-warning">{{ bem.situacao }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bem.localizacao %}
                                    <span class="text-success">{{ bem.localizacao[:30] }}{% if bem.localizacao|length > 30 %}...{% endif %}</span>
                                    {% else %}
                                    <span class="text-muted">Não informada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bem.responsavel %}
                                    {{ bem.responsavel }}
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ bem.data_localizacao[:10] if bem.data_localizacao else 'Nunca' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="editarBem({{ bem.id }})"
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-info" 
                                                onclick="visualizarBem('{{ bem.numero }}')"
                                                title="Visualizar">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="confirmarExclusao({{ bem.id }}, '{{ bem.numero }}')"
                                                title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                    <h4 class="text-muted">Nenhum bem encontrado</h4>
                    <p class="text-muted">
                        {% if termo_busca %}
                        Nenhum resultado para "{{ termo_busca }}". Tente outros termos.
                        {% else %}
                        Não há bens cadastrados no sistema.
                        {% endif %}
                    </p>
                    <button class="btn btn-primary" onclick="abrirModalCriacao()">
                        <i class="bi bi-plus-circle me-1"></i>Cadastrar Primeiro Bem
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Paginação -->
            {% if paginacao.total_paginas > 1 %}
            <div class="card-footer bg-white border-0">
                <nav aria-label="Navegação de páginas">
                    <ul class="pagination justify-content-center mb-0">
                        {% if paginacao.pagina_atual > 1 %}
                        <li class="page-item">
                            <a class="page-link" 
                               href="{{ url_for('sistema_crud', pagina=paginacao.pagina_atual-1, q=termo_busca) }}">
                                Anterior
                            </a>
                        </li>
                        {% endif %}

                        {% for pagina in range(1, paginacao.total_paginas + 1) %}
                        <li class="page-item {% if pagina == paginacao.pagina_atual %}active{% endif %}">
                            <a class="page-link" 
                               href="{{ url_for('sistema_crud', pagina=pagina, q=termo_busca) }}">
                                {{ pagina }}
                            </a>
                        </li>
                        {% endfor %}

                        {% if paginacao.pagina_atual < paginacao.total_paginas %}
                        <li class="page-item">
                            <a class="page-link" 
                               href="{{ url_for('sistema_crud', pagina=paginacao.pagina_atual+1, q=termo_busca) }}">
                                Próxima
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Modal de Criação/Edição -->
    <div class="modal fade" id="modalBem" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Novo Bem Patrimonial</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formBem">
                        <input type="hidden" id="bem_id" name="bem_id">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Número do Bem *</label>
                                <input type="text" class="form-control" id="numero" name="numero" required
                                       pattern="[A-Za-z0-9-]+" placeholder="Ex: 469704, ABC-123">
                                <div class="form-text">Apenas letras, números e hífen</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Situação *</label>
                                <select class="form-select" id="situacao" name="situacao" required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="OK">Localizado</option>
                                    <option value="Inativo">Inativo</option>
                                    <option value="Manutenção">Em Manutenção</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Nome do Item *</label>
                                <input type="text" class="form-control" id="nome" name="nome" required
                                       placeholder="Ex: Computador, Mesa, Cadeira...">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Localização</label>
                                <textarea class="form-control" id="localizacao" name="localizacao" rows="2"
                                          placeholder="Ex: Almoxarifado Central, Sala 101..."></textarea>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Responsável</label>
                                <input type="text" class="form-control" id="responsavel" name="responsavel"
                                       placeholder="Nome do responsável">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Auditor</label>
                                <input type="text" class="form-control" id="auditor" name="auditor"
                                       placeholder="Nome do auditor">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Data Última Vistoria</label>
                                <input type="date" class="form-control" id="data_ultima_vistoria" 
                                       name="data_ultima_vistoria">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Data Vistoria Atual</label>
                                <input type="date" class="form-control" id="data_vistoria_atual" 
                                       name="data_vistoria_atual">
                            </div>
                            
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Campos marcados com * são obrigatórios
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarBem()">Salvar Bem</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="modalConfirmacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o bem <strong id="numeroBemExcluir"></strong>?</p>
                    <p class="text-muted small">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
                </div>
            </div>
        </div>
    </div>

     <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais
        let bemEditando = null;
        const modalBem = new bootstrap.Modal(document.getElementById('modalBem'));
        const modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacao'));

        // Funções do CRUD
        function abrirModalCriacao() {
            document.getElementById('modalTitulo').textContent = 'Novo Bem Patrimonial';
            document.getElementById('formBem').reset();
            document.getElementById('bem_id').value = '';
            bemEditando = null;
            modalBem.show();
        }

        function editarBem(bemId) {
            console.log('Buscando bem com ID:', bemId);
            
            // ✅ CORREÇÃO: Usar a rota existente que busca por número, não por ID
            // Primeiro precisamos obter o número do bem para então buscar na API
            
            // Buscar o número do bem na linha da tabela
            const linha = document.querySelector(`button[onclick*="editarBem(${bemId})"]`)?.closest('tr');
            if (linha) {
                const numeroBem = linha.cells[0].textContent.trim();
                console.log('Número do bem encontrado:', numeroBem);
                
                fetch(`/api/bens/${encodeURIComponent(numeroBem)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Resposta da API:', data);
                        
                        if (data.success) {
                            const bem = data.data;
                            bemEditando = bem.id; // ✅ Agora temos o ID correto
                            
                            document.getElementById('modalTitulo').textContent = `Editar Bem: ${bem.numero}`;
                            document.getElementById('bem_id').value = bem.id;
                            document.getElementById('numero').value = bem.numero;
                            document.getElementById('nome').value = bem.nome;
                            document.getElementById('situacao').value = bem.situacao || 'Pendente';
                            document.getElementById('localizacao').value = bem.localizacao || '';
                            document.getElementById('responsavel').value = bem.responsavel || '';
                            document.getElementById('auditor').value = bem.auditor || '';
                            document.getElementById('data_ultima_vistoria').value = bem.data_ultima_vistoria || '';
                            document.getElementById('data_vistoria_atual').value = bem.data_vistoria_atual || '';
                            
                            modalBem.show();
                        } else {
                            alert('Erro ao carregar dados do bem: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Erro ao carregar dados do bem: ' + error.message);
                    });
            } else {
                alert('Não foi possível encontrar os dados do bem na tabela.');
            }
        }

        function visualizarBem(numeroBem) {
            window.open(`/?numero_bem=${encodeURIComponent(numeroBem)}`, '_blank');
        }

        function salvarBem() {
            const formData = new FormData(document.getElementById('formBem'));
            const dados = Object.fromEntries(formData);
            
            // Validações
            if (!dados.numero || !dados.nome || !dados.situacao) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // ✅ CORREÇÃO: Usar a rota correta para edição
            const url = bemEditando ? `/api/bens/${bemEditando}` : '/api/bens';
            const method = bemEditando ? 'PUT' : 'POST';

            console.log('Enviando dados:', { url, method, dados, bemEditando });

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dados)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta do servidor:', data);
                if (data.success) {
                    modalBem.hide();
                    alert(data.message || 'Bem salvo com sucesso!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar bem: ' + error.message);
            });
        }

        function confirmarExclusao(bemId, numeroBem) {
            document.getElementById('numeroBemExcluir').textContent = numeroBem;
            document.getElementById('btnConfirmarExclusao').onclick = () => excluirBem(bemId);
            modalConfirmacao.show();
        }

        function excluirBem(bemId) {
            // ✅ CORREÇÃO: Usar a rota correta para exclusão por ID
            fetch(`/api/bens/${bemId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                modalConfirmacao.hide();
                if (data.success) {
                    alert(data.message || 'Bem excluído com sucesso!');
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir bem: ' + error.message);
            });
        }

        // Validação em tempo real do número do bem
        document.getElementById('numero')?.addEventListener('input', function(e) {
            if (!/^[A-Za-z0-9-]*$/.test(e.target.value)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });

        // ✅ ADICIONAR: Debug para verificar os dados na tabela
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DEBUG: Dados da Tabela ===');
            document.querySelectorAll('tbody tr').forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                const numero = cells[0].textContent.trim();
                const nome = cells[1].textContent.trim();
                const btnEditar = row.querySelector('button[onclick*="editarBem"]');
                const match = btnEditar?.getAttribute('onclick')?.match(/editarBem\((\d+)\)/);
                const id = match ? match[1] : 'N/A';
                
                console.log(`Linha ${index + 1}: ID=${id}, Número=${numero}, Nome=${nome}`);
            });
        });
    </script>
</body>
</html>  